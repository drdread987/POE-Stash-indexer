<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>POE-price-helper</title>
        <link rel="stylesheet" href="./style.css">
        <link rel="stylesheet" href="./font/stylesheet.css">
        <!--<script href="https://cdnjs.com/libraries/Chart.js"></script>-->
    </head>
    <body>
        <div class="container" id="market-rates">
            <span class="title">Market rates</span>
            <img class="loading" src="./media/loading.gif" alt=""><br><br>
            <table>
                <tr>
                    <td>
                        <span id="alt">
                            <img src="./media/alt.png" alt=""><br>
                            <span class="rate">-</span>
                        </span>
                    </td>
                    <td>
                        <span id="alch">
                            <img src="./media/alch.png" alt=""><br>
                            <span class="rate">-</span>
                        </span>
                    </td>
                    <td>
                        <span id="fuse">
                            <img src="./media/fuse.png" alt=""><br>
                            <span class="rate">-</span>
                        </span>
                    </td>
                    <td>
                        <span id="chaos">
                            <img src="./media/chaos.png" alt=""><br>
                            <span class="rate">-</span>
                        </span>
                    </td>
                    <td>
                        <span id="exa">
                            <img src="./media/exa.png" alt=""><br>
                            <span class="rate">-</span>
                        </span>
                    </td>
                    <td>
                        <span id="chisel">
                            <img src="./media/chisel.png" alt=""><br>
                            <span class="rate">-</span>
                        </span>
                    </td>
                    <td>
                        <span id="prism">
                            <img src="./media/prism.png" alt=""><br>
                            <span class="rate">-</span>
                        </span>
                    </td>
                    <td>
                        <span id="chrome">
                            <img src="./media/chrome.png" alt=""><br>
                            <span class="rate">-</span>
                        </span>
                    </td>
                    <td>
                        <span id="jew">
                            <img src="./media/jew.png" alt=""><br>
                            <span class="rate">-</span>
                        </span>
                    </td>
                    <td>
                        <span id="chance">
                            <img src="./media/chance.png" alt=""><br>
                            <span class="rate">-</span>
                        </span>
                    </td>
                    <td>
                        <span id="scouring">
                            <img src="./media/scouring.png" alt=""><br>
                            <span class="rate">-</span>
                        </span>
                    </td>
                    <td>
                        <span id="bless">
                            <img src="./media/bless.png" alt=""><br>
                            <span class="rate">-</span>
                        </span>
                    </td>
                    <td>
                        <span id="regret">
                            <img src="./media/regret.png" alt=""><br>
                            <span class="rate">-</span>
                        </span>
                    </td>
                    <td>
                        <span id="regal">
                            <img src="./media/regal.png" alt=""><br>
                            <span class="rate">-</span>
                        </span>
                    </td>
                    <td>
                        <span id="divine">
                            <img src="./media/divine.png" alt=""><br>
                            <span class="rate">-</span>
                        </span>
                    </td>
                    <td>
                        <span id="vaal">
                            <img src="./media/vaal.png" alt=""><br>
                            <span class="rate">-</span>
                        </span>
                    </td>
                    <td>
                        <span id="wisdom">
                            <img src="./media/wisdom.png" alt=""><br>
                            <span class="rate">-</span>
                        </span>
                    </td>
                    <td>
                        <span id="portal">
                            <img src="./media/portal.png" alt=""><br>
                            <span class="rate">-</span>
                        </span>
                    </td>
                    <td>
                        <span id="scrap">
                            <img src="./media/scrap.png" alt=""><br>
                            <span class="rate">-</span>
                        </span>
                    </td>
                    <td>
                        <span id="stone">
                            <img src="./media/stone.png" alt=""><br>
                            <span class="rate">-</span>
                        </span>
                    </td>
                    <td>
                        <span id="bauble">
                            <img src="./media/bauble.png" alt=""><br>
                            <span class="rate">-</span>
                        </span>
                    </td>
                    <td>
                        <span id="trans">
                            <img src="./media/trans.png" alt=""><br>
                            <span class="rate">-</span>
                        </span>
                    </td>
                    <td>
                        <span id="aug">
                            <img src="./media/aug.png" alt=""><br>
                            <span class="rate">-</span>
                        </span>
                    </td>
                    <td>
                        <span id="eternal">
                            <img src="./media/eternal.png" alt=""><br>
                            <span class="rate">-</span>
                        </span>
                    </td>
                    <td>
                        <span id="mirror">
                            <img src="./media/mirror.png" alt=""><br>
                            <span class="rate">-</span>
                        </span>
                    </td>
                    <td>
                        <label>
                            <select id="base-currency">
                                <option selected disabled>Base curreny</option>
                                <option value="alt">alt</option>
                                <option value="fuse">fuse</option>
                                <option value="alch">alch</option>
                                <option value="chaos">chaos</option>
                                <option value="prism">prism</option>
                                <option value="exa">exa</option>
                                <option value="chrome">chrome</option>
                                <option value="jew">jew</option>
                                <option value="chance">chance</option>
                                <option value="chisel">chisel</option>
                                <option value="scouring">scouring</option>
                                <option value="bless">bless</option>
                                <option value="regret">regret</option>
                                <option value="regal">regal</option>
                                <option value="divine">divine</option>
                                <option value="vaal">vaal</option>
                                <option value="wisdom">wisdom</option>
                                <option value="portal">portal</option>
                                <option value="scrap">scrap</option>
                                <option value="stone">stone</option>
                                <option value="bauble">bauble</option>
                                <option value="trans">trans</option>
                                <option value="aug">aug</option>
                                <option value="eternal">eternal</option>
                                <option value="mirror">mirror</option>
                            </select>
                        </label>
                        <br>
                        <br>
                        <input type="button" id="update-market" value="Update">
                    </td>
                </tr>
            </table>
        </div>
        <br>

        <div class="container" id="settings">
            <span class="title">Parameters</span><br><br>
            <table>
                <tr>
                    <td>
                        <span>League</span>&nbsp;
                        <label>
                            <select id="league">
                                <option selected value="Standard">Standard</option>
                                <option value="Essence">Essence</option>
                            </select>
                        </label>
                    </td>
                    <td>
                        <span>Item type</span>&nbsp;
                        <label>
                            <select id="item-type">
                                <option selected value="any">Any</option>
                                <option disabled>Weapons</option>
                                <option value="bow">Bow</option>
                                <option value="claw">Claw</option>
                                <option value="dagger">Dagger</option>
                                <option value="sceptre">Sceptre</option>
                                <option value="staff">Staff</option>
                                <option value="wand">Wand</option>
                                <option disabled>Armor</option>
                                <option value="body-armor">Body armor</option>
                                <option value="boots">Boots</option>
                                <option value="gloves">Gloves</option>
                                <option value="helmet">Helmet</option>
                                <option value="shield">Shield</option>
                                <option disabled>Misc</option>
                                <option value="amulet">Amulet</option>
                                <option value="belt">Belt</option>
                                <option value="currency">Currency</option>
                                <option value="divination-card">Divination Card</option>
                                <option value="flask">Flask</option>
                                <option value="gem">Gem</option>
                                <option value="jewel">Jewel</option>
                                <option value="map">Map</option>
                                <option value="prophecy">Prophecy</option>
                                <option value="quiver">Quiver</option>
                                <option value="ring">Ring</option>
                                <option value="map-fragments">Map</option>
                                <option value="fragment">Fragment</option>
                            </select>
                        </label>
                    </td>
                    <td>
                        <span>Rarity</span>&nbsp;
                        <label>
                            <select id="rarity">
                                <option value="any" selected>Any</option>
                                <option value="0">Standard</option>
                                <option value="1">Magic</option>
                                <option value="2">Rare</option>
                                <option value="3">Unique</option>
                            </select>
                        </label>
                    </td>
                    <td>
                        <span>Corrupted</span>
                        &nbsp;
                        <label>
                            <select id="corrupted">
                                <option value="either" selected>Either</option>
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </label>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input type="text" id="item-level" placeholder="Item level">
                    </td>
                    <td>
                        <span>Item subtype</span>&nbsp;
                         <label>
                            <select id="item-subtype">
                            </select>
                        </label>
                    </td>
                    <td>
                        <span>Identified</span>&nbsp;
                        <label>
                            <select id="identified">
                                <option value="either" selected>Either</option>
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </label>
                    </td>
                    <td>
                        <input type="checkbox" id="verified" checked="true">Verified
                    </td>
                </tr>
            </table>
        </div>
        <br>

        <div class="container" id="search">
            <table>
                <tr>
                    <th>
                        <span class="title">Search</span>
                    </th>
                    <th>
                        <span class="title">Price stats</span>
                    </th>
                    <th>
                        <span class="title">Results</span>
                    </th>
                    <th>
                        <span class="title">Item preview</span>
                    </th>
                </tr>
                <tr>
                    <td>
                        <label>
                            <select id="search-by">
                                <option value="name">Item Name</option>
                                <option value="lastCharacterName">character</option>
                                <option value="accountName">Account</option>
                                <option value="mods">Mods</option>
                            </select>
                        </label>
                    </td>
                    <td>
                        Kept <span id="kept-items">0</span> items out of <span id="total-items">0</span>.
                    </td>
                    <td rowspan="3">
                        <div id="results">
                            <table>
                            </table>
                        </div>
                    </td>
                    <td id="preview" rowspan="3" width="20%">
                        <div id="item-overlay">
                            <div id="price">
                                2
                                <img src="./media/exa.png">
                            </div>
                            <span id="item-name">Roth's Reach</span><br>
                            <span id="item-type-prev">Recurve Bow</span><br>
                            <span id="item-prophecy-text"></span><br>
                            <div id="item-properties">
                                <span class="item-property">Bow</span><br>
                                <span class="item-property">Quality</span>
                                <span class="item-value">+17%</span>
                                <br>
                                <span class="item-property">Physical Damage:</span>
                                <span class="item-value">20-63</span><br>
                                <span class="item-property">Critical Strike Chance:</span>
                                <span class="item-value">6.50%</span><br>
                                <span class="item-property">Attacks per Second:</span>
                                <span class="item-value">1.31</span><br>
                            </div><br>
                            <span id="item-enchant-mods">20% for Discharge not to Consume a Charge</span>
                            <div id="item-implicit-mods">
                            </div><br>
                            <div id="item-explicit-mods">
                                <span>68% increased Physical Damage</span><br>
                                <span>34% increased Elemental Damage with Weapons</span><br>
                                <span>5% increased Attack Speed</span><br>
                                <span>Skills Chain +1 times</span><br>
                                <span>30% increased Projectile Speed</span>
                            </div>
                            <div id="item-crafted-mods">
                                <span>Causes Bleeding on Hit</span><br>
                            </div><br>
                            <div id="item-corrupted">
                                Corrupted
                            </div>
                            <div id="item-flavor">
                                <span>"Exiled to the sea; what a joke.</span><br>
                                <span>I'm more free than I've ever been."
</span><br>
                                <span>- Captain Weylam "Rot-tooth" Roth of the Black Crest</span>
                            </div>
                        </div>
                        <div id="sockets">
                            <img class="socket" id="socket1" src="./media/socket_dex.png" alt="">
                            <img class="socket" id="socket2" src="./media/socket_dex.png" alt="">
                            <img class="socket" id="socket3" src="./media/socket_dex.png" alt="">
                            <img class="socket" id="socket4" src="./media/socket_dex.png" alt="">
                            <img class="socket" id="socket5" src="./media/socket_dex.png" alt="">
                            <img class="socket" id="socket6" src="./media/socket_dex.png" alt="">
                            <img class="socket" id="socket-vert-1" src="./media/socket_dex.png" alt="">
                            <img class="socket" id="socket-vert-2" src="./media/socket_dex.png" alt="">
                            <img class="socket" id="socket-vert-3" src="./media/socket_dex.png" alt="">
                            <img class="link" id="link1" src="./media/socket_link_horiz.png" alt="">
                            <img class="link" id="link2" src="./media/socket_link_vert.png" alt="">
                            <img class="link" id="link3" src="./media/socket_link_horiz.png" alt="">
                            <img class="link" id="link4" src="./media/socket_link_vert.png" alt="">
                            <img class="link" id="link5" src="./media/socket_link_horiz.png" alt="">
                            <img class="link" id="link-vert-1" src="./media/socket_link_vert.png" alt="">
                            <img class="link" id="link-vert-2" src="./media/socket_link_vert.png" alt="">
                        </div>
                        <!--<img class="loading" src="./media/loading.gif" alt="">-->
                        <img id="item-picture" src="http://web.poecdn.com/image/Art/2DItems/Weapons/TwoHandWeapons/Bows/SarkhamsReach.png?scale=1&w=2&h=4&v=f333c2e4005ee20a84270731baa5fa6a3" alt="">
                    </td>
                </tr>
                <tr>
                    <td>
                        <textarea rows="" cols=""></textarea>
                    </td>
                    <td>
                        <div id="plot">
                            <canvas id="myChart" width="300" height="200"></canvas>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input type="checkbox" id="auto-refresh">Auto-refreesh<br><br>
                        <input type="button" id="search-item" value="Search">
                        <img class="loading" src="./media/loading.gif" alt="">
                    </td>
                    <td>
                        <table id="prices">
                            <tr>
                                <td>Average price:</td>
                                <td><span id="avg-price">2.0 chaos</span></td>
                            </tr>
                            <tr>
                                <td>Median price:</td>
                                <td><span id="median-price">2.0 chaos</span></td>
                            </tr>
                            <tr>
                                <td>Mode price:</td>
                                <td><span id="mode-price">2.0 chaos</span></td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
        </div>

        <script type="text/javascript">
            var $ = require('jquery');
            
            $( document ).ready( function() {
                var league   = "Standard";
                var Chart    = require('./node_modules/chart.js/src/chart.js')
                var Currency = require( "./modules/currency" );
                var currency = new Currency( league );
                var mongo_client = require( "mongodb" ).MongoClient;
                const notifier   = require('node-notifier');
                var Logger       = require( "./modules/logger.js" );
                var logger       = new Logger();
                logger.set_use_timestamp( true );
                logger.set_file_path( "log.txt" );
                var async        = require( "async" );
                var ncp          = require( "copy-paste" );
                var itemTypes    = require( "./itemTypes.json" );
                var leagueRates  = {
                    alch: 0.3655772464721796,
                    alt: 0.10982493904715883,
                    armour: 0.017393724344256595,
                    aug: 0.03528681120144535,
                    bauble:0.20452825557850815,
                    bless:0.7427213309566251,
                    chance:0.30819490245631337,
                    chaos:1,
                    chisel:0.47952431188261246,
                    chrome:0.1860153648691382,
                    divine:30.030030030030026,
                    exa:77.51937984496124,
                    fuse:0.8206138191367143,
                    jew:0.18509606485766114,
                    portal:0.013979503252331433,
                    prism:2.0815986677768525,
                    regal:1.6207455429497568,
                    regret:2.2696323195642307,
                    scouring:1.1482374555057986,
                    stone:0.03330824112501915,
                    trans:0.02465963538263123,
                    vaal:1.9770660340055357,
                    wisdom:0.007426159836208619
                };
                var baseCurrency = "chaos";
                var dbHandler;
                var myChart;
                // var config       = require( 'node-cfg' );
                // var address      = config.db.address;
                // var port         = config.db.port;
                // var database     = config.db.db;
                var address      = "localhost";
                // var address      = "server.local";
                var port         = 27017;
                var database     = "POE_price";
                var script_name  = "index.html";
                var queryLimit   = 10000;
                var fields       = {
                    "name": 1,
                    "typeLine": 1,
                    "implicitMods": 1,
                    "explicitMods": 1,
                    "craftedMods": 1,
                    "enchantMods": 1,
                    "flavourText": 1,
                    "icon": 1,
                    "note": 1,
                    "stashName": 1,
                    "properties": 1,
                    "frameType": 1,
                    "corrupted": 1,
                    "identified": 1,
                    "sockets": 1,
                    "lastCharacterName": 1,
                    "ilvl": 1,
                    "w": 1,
                    "addedTs": 1,
                    "updatedTs": 1,
                    "available": 1,
                    "prophecyText": 1,
                    "prophecyDiffText": 1,
                    "artFilename": 1
                };
                var autorefreshInterval;

                /**
                 * Query DB
                 *
                 * @params MongoDB handler, criteria, league, the type, a callback 
                 * the results will be sent to
                 * @return DB results matching the criteria
                */
                function queryDB( db, criteria, league, queryBy, callback ) {
                    var entries = [];
                    console.log( "Querying by " + queryBy );
                    console.log( criteria );
                    var start      = new Date();
                    var rarity     = $( "#rarity" ).val();
                    var type       = $( "#item-subtype" ).val();
                    var identified = $( "#identified" ).val();
                    var corrupted  = $( "#corrupted" ).val();
                    var level      = $( "#item-level" ).val();
                    var available  = $( "#verified" ).is( ":checked" );
                    var cursor;
                    if ( !available ) {
                        available = [true, false];
                    } else {
                        available = [true];
                    }
                    if ( level === "" ) {
                        level = 0;
                    } else {
                        level = parseInt( level );
                    }
                    if ( identified !== "either" ) {
                        var bool   = (identified === "true");
                        identified = [bool];
                        logger.log( "identified: " + identified, script_name );
                    } else {
                        identified = [true, false];
                    }
                    if ( corrupted !== "either" ) {
                        var bool  = (corrupted === "true");
                        corrupted = [bool];
                        logger.log( "corrupted: " + corrupted, script_name );
                    } else {
                        corrupted = [true, false];
                    }
                    if ( !type || type === "any" ) {
                        type = / /;
                    }
                    if ( rarity === "any" ) {
                        rarity = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
                        console.log( "any" );
                    } else {
                        rarity = [parseInt( rarity)];
                    }

                    // var fragment = ( itemTypes.fragment.types.indexOf( criteria ) !== -1 );
                    if ( queryBy === "name" ) {
                        if ( criteria === "" ) {
                        // if ( criteria === "" || fragment ) {
                            console.log( "Fragment" );
                            // if ( fragment ) {
                            //     type = criteria;
                            // }
                            cursor = db.collection('stashes').find({
                                "league": league, 
                                "frameType": { $in: rarity },
                                "typeLine": type,
                                "available": { $in: available },
                                "corrupted": { $in: corrupted },
                                "identified": { $in: identified },
                                "ilvl": { $gte: level }
                            }, fields).limit(queryLimit);
                        } else {
                            cursor = db.collection('stashes').find({
                                "name": "<<set:MS>><<set:M>><<set:S>>" + criteria,
                                "league": league, 
                                "frameType": { $in: rarity },
                                "typeLine": type,
                                "available": { $in: available },
                                "corrupted": { $in: corrupted },
                                "identified": { $in: identified },
                                "ilvl": { $gte: level }
                            }, fields).limit(queryLimit);
                        }
                        
                    } else if ( queryBy === "lastCharacterName" ) {
                        cursor = db.collection('stashes').find({
                            "lastCharacterName": criteria,
                            "league": league, 
                            "frameType": { $in: rarity },
                            "typeLine": type,
                            "available": { $in: available },
                            "corrupted": { $in: corrupted },
                            "identified": { $in: identified },
                            "ilvl": { $gte: level }
                        }, fields ).limit(queryLimit);
                    } else if ( queryBy === "accountName" ) {
                        cursor = db.collection('stashes').find({
                            "accountName": criteria,
                            "league": league, 
                            "frameType": { $in: rarity },
                            "typeLine": type,
                            "available": { $in: available },
                            "corrupted": { $in: corrupted },
                            "identified": { $in: identified },
                            "ilvl": { $gte: level }
                        }, fields).limit(queryLimit);
                    } else if ( queryBy === "mods" ) {
                        cursor = db.collection('stashes').find({
                            $or: [
                                {"explicitMods": { 
                                    $all: criteria
                                }},
                                {"implicitMods": { 
                                    $all: criteria
                                }},
                                {"craftedMods": { 
                                    $all: criteria
                                }},
                                {"enchantMods": { 
                                    $all: criteria
                                }}, 
                            ],
                            "league": league, 
                            "frameType": { $in: rarity },
                            "typeLine": type,
                            "available": { $in: available },
                            "corrupted": { $in: corrupted },
                            "identified": { $in: identified },
                            "ilvl": { $gte: level }
                        }, fields).limit(queryLimit);
                    } else {
                        logger.log( "unrecognised query type " + queryBy, script_name, "e" );
                    }

                    if ( cursor !== undefined ) {
                        logger.log( "Gathering results", script_name );
                        cursor.each( function( err, doc ) {
                            if ( doc !== null ) {
                                entries.push( doc );
                            } else {
                                logger.log( "Found " + entries.length + " entries (" + 
                                            ( new Date() - start ) + "ms)", script_name );
                                cursor.close();
                                db.close();
                                callback( entries, averagePrice );
                            }
                        });
                    } else {
                        logger.log( "No items found with these criterias", 
                                    script_name, "e" );
                        db.close();
                    }
                }

                /**
                 * Connect to MongoDB. If successfull, run provided callback function
                 * 
                 * @params Callback function
                 * @return None
                 */
                function connectToDB( callback ) {
                    // Connect to the db
                    mongo_client.connect( "mongodb://" + address + ":" + port + "/" + database, 
                                        function( err, db ) {
                        if ( err !== null ) {
                            logger.log( err, script_name, "e" );
                            logger.log( "Make sure MongoDB has been started", 
                                        script_name, "e" );
                            $( "#search .loading" ).fadeOut( 'fast' );
                        }
                        logger.log( "Connected to MongoDB.", script_name );
                        
                        callback( db );
                    });
                }

                /**
                 * Filter list of items to only keep valid price expression
                 *
                 * For each item in the list, check if it matches the price
                 * regexp. If it does, store its price with the currency it is
                 * in.
                 * @params a list of item, a callback to send the list to
                 * @return nothing
                 */
                function filterValidPrice( items, callback ) {
                    var priceReg        = /[^0-9]*([0-9]+|(?:[0-9.]+[0-9]+))\s+(chaos|exa|alch|alt|fuse|divine|chance|jew)/;
                    var results         = [];
                    
                    for ( var i = 0 ; i < items.length ; i++ ) {
                        var item = items[i];
                        var price;
                        if ( item.note ) {
                            price = item.note;
                        } else {
                            price = item.stashName;
                        }
                        console.log( "Trying to match: " + price );
                        var match = priceReg.exec( price );
                        // Check if we have a valid poe price (exemple: ~b/o 2 chaos)
                        if ( match != null && match[1] != "0" ) {
                            item.price    = match[1];
                            item.currency = match[2];
                            results.push( item );
                            // console.log( "Keeping " + item.name + " " + item.note + " " + item.stashName );
                        } else {
                            // console.log( "Discarding " + item.name + " " + item.note + " " + item.stashName );
                        }
                    }
                    logger.log( "Kept " + results.length + " items", script_name );
                    $( "#kept-items" ).text( results.length );
                    $( "#total-items" ).text( items.length );
                    updateInterface( results );
                    callback( results );
                }

                /**
                 * Returns the median value of an array
                 *
                 * Sort array, then return its median
                 * @params array
                 * @return median value
                 */
                var median = function( values ) {
                    values.sort( function( a, b ) { return a - b });
                    if ( values.length % 2 === 1 ) {
                        return values[( values.length - 1 ) / 2];
                    } else {
                        return ( values[( values.length / 2 - 1 )] + 
                                values[values.length / 2]) / 2;
                    }
                }

                /**
                 * Return average and median prices of a set of items
                 * 
                 * For each item of the set, sum its price in chaos to a global sum and
                 * divide by the number of items. Then sort the prices and extract the 
                 * median value. Print the average and median prices.
                 * @params sets of items
                 * @return nothing 
                 */
                var averagePrice = function( results ) {
                    var shouldNotify = true;
                    var sum          = 0;
                    var medians      = [];
                    var modes        = {};
                    var unit         = "chaos";
                    var unitAverage  = "chaos";
                    var unitMedian   = "chaos";
                    var unitMode     = "chaos";
                    results.sort( function( a, b ) {
                        return a.price * leagueRates[a.currency] - 
                               b.price * leagueRates[b.currency];
                    })
                    for ( var i = 0 ; i < results.length ; i++ ) {
                        // console.log( results[i].price + " : " + results[i].currency + " -> " + 
                                    //  parseFloat( results[i].price ) + " * " + leagueRates[results[i].currency] );
                        var price = parseFloat( results[i].price ) * leagueRates[results[i].currency];
                        sum += price;
                        medians.push( price );
                        if ( modes["" + price + ""]) {
                            modes["" + price + ""]++;
                        } else {
                            modes["" + price + ""] = 1;
                        }
                    }
                    console.log( sum );
                    // Computes the median
                    var med = median( medians );
                    var avg = sum / results.length;
                    var medProportion = 0;
                    for ( var i = 0 ; i < medians.length ; i++ ) {
                        if ( medians[i] <= med ) {
                            medProportion++;
                        }
                    }
                    medProportion = medProportion * 100 / medians.length;
                    // Computes the mode
                    var mode    = { "amount": 0, "value": 0 };
                    var values  = [];
                    var amounts = [];
                    // sort modes
                    var keys    = [];
                    for ( var val in modes ) {
                        if ( modes.hasOwnProperty( val )) {
                            keys.push( val );
                        }
                    }
                    keys.sort( function( a, b ) {
                        return a - b;
                    });
                    // console.log( keys );
                    // var modesSorted = {};
                    for ( var i = 0 ; i < keys.length ; i++ ) {
                        // modesSorted["" + keys[i] + ""] = modes[keys[i]];
                        // console.log( modes[keys[i]] );
                        values.push( keys[i]);
                        amounts.push( modes[keys[i]]);
                    }
                    // console.log( modesSorted );
                    for ( var val in modes ) {
                        if ( modes.hasOwnProperty( val )) {
                            if ( modes[val] > mode.amount ) {
                                mode.value = val;
                                mode.amount = modes[val];
                            }
                        }
                    }
                    var chartParam = { 
                        "values": values, 
                        "amounts": amounts, 
                        "currency": "chaos"
                    };
                    if ( avg > leagueRates.exa ) {
                        avg /= leagueRates.exa;
                        unitAverage = "exalt";
                    }
                    if ( med > leagueRates.exa ) {
                        med /= leagueRates.exa;
                        unitMedian = "exalt";
                    }
                    if ( mode.value > leagueRates.exa ) {
                        mode.value /= leagueRates.exa;
                        unitMode = "exalt";
                        values = values.map( function( e ) {
                            return e / leagueRates.exa;
                        });
                        chartParam.currency = "exa";
                        chartParam.values   = values;
                    }

                    $( "#avg-price" ).text( Math.round( avg * 100 ) / 100 + " " + unitAverage );
                    $( "#median-price" ).text( Math.round( med * 100 ) / 100 + " " + unitMedian );
                    $( "#mode-price" ).text( Math.round( mode.value * 100 ) / 100 + " " + unitMode );
                    logger.log( "Average price is " + Math.round( avg * 100 ) / 100 + " " + unitAverage, 
                                script_name );
                    logger.log( "Median price is " + Math.round( med * 100 ) / 100 + " " + unitMedian +
                                " ( " + Math.round( medProportion * 100 ) / 100 + " % items)", 
                                script_name );
                    logger.log( "Mode price is " + Math.round( mode.value * 100 ) / 100 + " " + unitMode, 
                                script_name );
                    if ( shouldNotify ) {
                        notifier.notify({
                            'title': 'Price based on ' + results.length + " items",
                            'message': "Average: " + Math.round( avg * 100 ) / 100 + " " + unitAverage + ".\n" + 
                                    "Median: " + Math.round( med * 100 ) / 100 + " " + unitMedian + ".\n" +
                                    "Mode: " + Math.round( mode.value * 100 ) / 100 + " " + unitMode,
                        });
                    }
                    drawChart( chartParam );
                    // process.exit( 0 );
                }

                /***
                 * secToNsec
                 * Converts a second amount to a higer unit (min, hour, day...) if possible.
                 * @param Second amount to convert
                 * @return JSON object with the converted value and corresponding unit
                 */
                function secToNsec( secAmount ) {
                    var units = [ "ms", "sec", "min", "hour", "day", "week", "month", "year" ];
                    var counter = 0;
                    if ( secAmount > 1000 ) {
                        secAmount /= 1000; // sec
                        counter++;
                        if ( secAmount > 60 ) {
                            secAmount /= 60; // minutes
                            counter++;
                            if ( secAmount > 60 ) {
                                secAmount /= 60; // hours
                                counter++;
                                if ( secAmount > 24 ) {
                                    secAmount /= 24; // days
                                    counter++;
                                    if ( secAmount > 365 ) {
                                        secAmount /= 365; // years
                                        counter = 6;
                                    } else if ( secAmount > 30 ) {
                                        secAmount /= 30; // month
                                        counter = 5;
                                    } else if ( secAmount > 7 ) {
                                        secAmount /= 7; // weeks
                                        counter++;
                                    }
                                }
                            }
                        }
                    }
                    
                    return { "amount": secAmount, "unit": units[counter]};
                }

                function updateInterface( results ) {
                    var current = Date.now();
                    $( "#search .loading" ).fadeOut( 'fast' );
                    $( "#results table" ).empty();
                    itemPreview( results[0]);
                    // sort results by price
                    results.sort( function( a, b ) {
                        // console.log( leagueRates[a.currency] );
                        return a.price * leagueRates[a.currency] - 
                               b.price * leagueRates[b.currency];
                    });
                    var counter = 0;
                    async.each( results, function( result, callbackUpdate ) {
                        var opacity = 1;
                        if ( !result.available ) {
                            opacity = 0.3;
                            console.log( result );
                        }
                        var color = "rgba(255, 255, 255, " + opacity + ")";
                        switch ( result.frameType ) {
                            case 1:
                                color = "rgba(135, 135, 254, " + opacity + ")";
                                break;
                            case 2:
                                color = "rgba(243, 243, 113, " + opacity + ")";
                                break;
                            case 3:
                                color = "rgba(175, 96, 37, " + opacity + ")";
                                break;
                            case 4:
                                color = "rgba(0, 255, 0, " + opacity + ")";
                                break;
                            case 5:
                                color = "rgba(170, 158, 130, " + opacity + ")";
                                break;
                            case 8:
                                color = "rgba(181, 75, 255, " + opacity + ")";
                                break;
                            default:
                        }
                        if ( result.corrupted ) {
                            color = "rgba(255, 0, 0, " + opacity + ")";
                        }
                        counter++;
                        var time = "";
                        if ( result.addedTs !== result.updatedTs ) {
                            var conv = secToNsec( current - result.updatedTs );
                            time = Math.round( conv.amount ) + " " + conv.unit;
                        } else {
                            var conv = secToNsec( current - result.addedTs );
                            time = Math.round( conv.amount ) + " " + conv.unit;
                        }

                        if ( result.frameType <= 1 || result.frameType > 3 ) {
                            $( "#results table" ).append(
                                "<tr>" +
                                    "<td id='" + counter + "' style='color: " + color + 
                                    "'>" + 
                                    result.typeLine.replace( "<<set:MS>><<set:M>><<set:S>>", "" ) + 
                                    " (" + result.price + 
                                    " <img class='currency-result' src='./media/" + 
                                    result.currency + ".png'>)" + 
                                    "<span class='ago'>" + time + "</span>" +
                                    "</td>" +
                                "</tr>"
                            );
                        } else {
                            $( "#results table" ).append(
                                "<tr>" +
                                    "<td id='" + counter + "' style='color: " + color + 
                                    "'>" + 
                                    result.name.replace( "<<set:MS>><<set:M>><<set:S>>", "" ) + 
                                    " (" + result.price + 
                                    " <img class='currency-result' src='./media/" + 
                                    result.currency + ".png'>)" +
                                    "<span class='ago'>" + time + "</span>" +
                                    "</td>" +
                                "</tr>"
                            );
                        }
                        $( "table td#" + counter ).data( "data-item" , result );
                        callbackUpdate();
                    }, function( err ) {
                        bindPreviewOnClick();
                        bindContactOnClick();
                    });
                }

                // Grab market prices for currencies
                function updateMarketRates( callback ) {
                    $( "#market-rates .title" ).html( "Market rates<span> (Updating...)</span>" );
                    $( "#market-rates .loading" ).fadeIn( 'fast' );
                    currency.getAllRates( baseCurrency, function( rates ) {
                        $( "#market-rates .loading" ).fadeOut( 'fast' );
                        leagueRates = rates;
                        console.log( rates );
                        $( "#alt .rate" ).text( Math.round( rates.alt * 100 ) / 100 );
                        $( "#fuse .rate" ).text( Math.round( rates.fuse * 100 ) / 100 );
                        $( "#alch .rate" ).text( Math.round( rates.alch * 100 ) / 100 );
                        $( "#chaos .rate" ).text( Math.round( rates.chaos * 100 ) / 100 );
                        $( "#prism .rate" ).text( Math.round( rates.prism * 100 ) / 100 );
                        $( "#exa .rate" ).text( Math.round( rates.exa * 100 ) / 100 );
                        $( "#chrome .rate" ).text( Math.round( rates.chrome * 100 ) / 100 );
                        $( "#jew .rate" ).text( Math.round( rates.jew * 100 ) / 100 );
                        $( "#chance .rate" ).text( Math.round( rates.chance * 100 ) / 100 );
                        $( "#chisel .rate" ).text( Math.round( rates.chisel * 100 ) / 100 );
                        $( "#scouring .rate" ).text( Math.round( rates.scouring * 100 ) / 100 );
                        $( "#bless .rate" ).text( Math.round( rates.bless * 100 ) / 100 );
                        $( "#regret .rate" ).text( Math.round( rates.regret * 100 ) / 100 );
                        $( "#regal .rate" ).text( Math.round( rates.regal * 100 ) / 100 );
                        $( "#divine .rate" ).text( Math.round( rates.divine * 100 ) / 100 );
                        $( "#vaal .rate" ).text( Math.round( rates.vaal * 100 ) / 100 );
                        $( "#wisdom .rate" ).text( Math.round( rates.wisdom * 100 ) / 100 );
                        $( "#portal .rate" ).text( Math.round( rates.portal * 100 ) / 100 );
                        $( "#scrap .rate" ).text( Math.round( rates.scrap * 100 ) / 100 );
                        $( "#stone .rate" ).text( Math.round( rates.stone * 100 ) / 100 );
                        $( "#bauble .rate" ).text( Math.round( rates.bauble * 100 ) / 100 );
                        $( "#trans .rate" ).text( Math.round( rates.trans * 100 ) / 100 );
                        $( "#aug .rate" ).text( Math.round( rates.aug * 100 ) / 100 );
                        $( "#eternal .rate" ).text( Math.round( rates.eternal * 100 ) / 100 );
                        $( "#mirror .rate" ).text( Math.round( rates.mirror * 100 ) / 100 );
                        var date = new Date();
                        var dateString = date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds();
                        $( "#market-rates .title" ).html( "Market rates</span> (" + dateString + ")</span>" );
                        callback();
                    });
                }

                function itemPreview( item ) {
                    $( "#price" ).empty();
                    $( "#price" ).html(
                        item.price + "<img src='./media/" + item.currency + ".png'>"
                    );
                    // Depending on the item width, change the left offset
                    $( "td#preview img.loading" ).show();
                    if ( item.frameType === 6 ) {
                        $( "#item-picture" ).css( "left", "0%" );
                    } else {
                        if ( item.w === 1 ) {
                            $( "#item-picture" ).css( "left", "40%" );
                        } else {
                            $( "#item-picture" ).css( "left", "30%" );
                        }
                    }
                    
                    // If it's a divination card, show the card art
                    if ( item.frameType === 6 ) {
                        $( "#item-picture" ).attr( 
                            "src", 
                            "http://web.poecdn.com/image/gen/divination_cards/" + item.artFilename + ".png" 
                        );
                    } else {
                        $( "#item-picture" ).attr( "src", item.icon );
                    }
                    
                    $( "td#preview img.loading" ).hide();
                    $( "#item-name" ).empty();
                    if ( item.frameType <= 1 || item.frameType > 3 ) {
                        $( "#item-name" ).text( item.typeLine.replace( "<<set:MS>><<set:M>><<set:S>>", "" ));
                    } else {
                        $( "#item-name" ).text( item.name.replace( "<<set:MS>><<set:M>><<set:S>>", "" ));
                    }
                    var color = "rgba(255, 255, 255, 1)";
                    switch ( item.frameType ) {
                        case 1:
                            color = "rgba(135, 135, 254, 1)";
                            break;
                        case 2:
                            color = "rgba(243, 243, 113, 1)";
                            break;
                        case 3:
                            color = "rgba(175, 96, 37, 1)";
                            break;
                        case 4:
                            color = "rgba(0, 255, 0, 1)";
                            break;
                        case 5:
                            color = "rgba(170, 158, 130, 1)";
                            break;
                        case 8:
                            color = "rgba(181, 75, 255, 1)";
                            break;
                        default:
                    }
                    if ( item.frameType !== 8 ) {
                        $( "#item-prophecy-text" ).hide();
                    } else {
                        $( "#item-prophecy-text" ).text( item.prophecyText );
                        $( "#item-prophecy-text" ).show();
                    }
                    $( "#item-name" ).css( "color", color );
                    $( "#item-type-prev" ).empty();
                    if ( item.frameType !== 1 && item.frameType !== 4 && 
                         item.frameType !== 5 && item.frameType !== 8 && 
                         item.frameType !== 0 && item.frameType !== 6 ) {
                        $( "#item-type-prev" ).text( item.typeLine );
                        console.log( item.frameType );
                    }
                    $( "#item-enchant-mods" ).empty();
                    if ( item.enchantMods ) {
                        for ( var i = 0 ; i < item.enchantMods.length; i++ ) {
                            var mod = item.enchantMods[i];
                            $( "#item-enchant-mods" ).append(
                                "<span>" + mod + "</span>"
                            );
                            if ( i !== item.enchantMods.length - 1 ) {
                                $( "#item-enchant-mods" ).append( "<br>" );
                            }
                        }
                        $( "#item-enchant-mods" ).show();
                    } else {
                        $( "#item-enchant-mods" ).hide();
                    }
                    
                    $( "#item-properties" ).empty();
                    if ( item.properties ) {
                        for ( var i = 0 ; i < item.properties.length; i++ ) {
                            var property = item.properties[i];
                            // if ( i !== 0 ) {
                                if ( property.values.length > 0 ) {
                                    $( "#item-properties" ).append(
                                        "<span class='item-property'>" + property.name + ": </span>" +
                                        "<span class='item-value'>" + property.values[0][0] + "</span>"
                                    );
                                } else {
                                    $( "#item-properties" ).append(
                                        "<span class='item-property'>" + property.name + "</span>"
                                    );
                                }
                                
                            // } else {
                                // $( "#item-properties" ).append(
                                    // "<span class='item-property'>" + property.name + "</span>"
                                // );
                            // }
                            if ( i !== item.properties.length - 1 ) {
                                $( "#item-properties" ).append( "<br>" );
                            }
                        }
                    }
                    $( "#item-implicit-mods" ).empty();
                    if ( item.implicitMods ) {
                        for ( var i = 0 ; i < item.implicitMods.length; i++ ) {
                            var mod = item.implicitMods[i];
                            $( "#item-implicit-mods" ).append(
                                "<span>" + mod + "</span>"
                            );
                            if ( i !== item.implicitMods.length - 1 ) {
                                $( "#item-implicit-mods" ).append( "<br>" );
                            }
                        }
                    }
                    $( "#item-explicit-mods" ).empty();
                    if ( item.explicitMods ) {
                        for ( var i = 0 ; i < item.explicitMods.length; i++ ) {
                            var mod = item.explicitMods[i];
                            $( "#item-explicit-mods" ).append(
                                "<span>" + mod + "</span>"
                            );
                            if ( i !== item.explicitMods.length - 1 ) {
                                $( "#item-explicit-mods" ).append( "<br>" );
                            }
                        }
                    }
                    // Crafted Mods
                    $( "#item-crafted-mods" ).empty();
                    if ( item.craftedMods ) {
                        for ( var i = 0 ; i < item.craftedMods.length; i++ ) {
                            var mod = item.craftedMods[i];
                            $( "#item-crafted-mods" ).append(
                                "<span>" + mod + "</span>"
                            );
                            if ( i !== item.craftedMods.length - 1 ) {
                                $( "#item-crafted-mods" ).append( "<br>" );
                            }
                        }
                        $( "#item-crafted-mods" ).show();
                    } else {
                        $( "#item-crafted-mods" ).hide();
                    }
                    // Corrupted
                    if ( item.corrupted ) {
                        $( "#item-corrupted" ).show();
                    } else {
                        $( "#item-corrupted" ).hide();
                    }
                    // Item sockets
                    $( ".socket" ).hide();
                    $( ".link" ).hide();
                    var currentSocketGroup = 0;
                    var lastSocketGroup = 0;
                    if ( item.sockets ) {
                        if ( item.properties ) {
                            if ( item.properties[0].name !== "Wand" && 
                                 item.properties[0].name !== "Dagger" ) {
                                for ( var i = 0 ; i < item.sockets.length ; i++ ) {
                                    var socketImg;
                                    switch ( item.sockets[i].attr ) {
                                        case "D":
                                            socketImg = "./media/socket_dex.png";
                                            break;
                                        case "I":
                                            socketImg = "./media/socket_int.png";
                                            break;
                                        case "S":
                                            socketImg = "./media/socket_str.png";
                                            break;
                                        case "G":
                                            socketImg = "./media/socket_white.png";
                                            break;
                                        default:
                                            socketImg = "./media/socket_white.png";
                                    }
                                    $( "#socket" + ( i + 1 )).attr( "src", socketImg );
                                    $( "#socket" + ( i + 1 )).show();
                                    currentSocketGroup = item.sockets[i].group;
                                    if ( i > 0 && currentSocketGroup == lastSocketGroup ) {
                                        $( "#link" + i ).show();
                                    } else if ( i > 0 && currentSocketGroup != lastSocketGroup ) {
                                    }
                                    lastSocketGroup = currentSocketGroup;
                                }
                            // Wands and daggers
                            } else {
                                for ( var i = 0 ; i < item.sockets.length ; i++ ) {
                                    var socketImg;
                                    switch ( item.sockets[i].attr ) {
                                        case "D":
                                            socketImg = "./media/socket_dex.png";
                                            break;
                                        case "I":
                                            socketImg = "./media/socket_int.png";
                                            break;
                                        case "S":
                                            socketImg = "./media/socket_str.png";
                                            break;
                                        case "G":
                                            socketImg = "./media/socket_white.png";
                                            break;
                                        default:
                                            socketImg = "./media/socket_white.png";
                                    }
                                    $( "#socket-vert-" + ( i + 1 )).attr( "src", socketImg );
                                    $( "#socket-vert-" + ( i + 1 )).show();
                                    currentSocketGroup = item.sockets[i].group;
                                    if ( i > 0 && currentSocketGroup == lastSocketGroup ) {
                                        $( "#link-vert-" + i ).show();
                                    } else if ( i > 0 && currentSocketGroup != lastSocketGroup ) {
                                    }
                                    lastSocketGroup = currentSocketGroup;
                                }
                            }
                        }
                    }
                    // Item flavor
                    $( "#item-flavor" ).empty();
                    if ( item.flavourText ) {
                        for ( var i = 0 ; i < item.flavourText.length; i++ ) {
                            var line = item.flavourText[i];
                            $( "#item-flavor" ).append(
                                "<span>" + line + "</span>"
                            );
                        }
                    }
                }

                function bindPreviewOnClick() {
                    $( "#results table td" ).mouseenter( function() {
                        var item = $( this ).data().dataItem;
                        // console.log( item );
                        itemPreview( item );
                    });
                }

                function bindContactOnClick() {
                    // When clicking on item in results
                    $( "#results table td" ).click( function() {
                        var item = $( this ).data().dataItem;
                        var str = "@" + item.lastCharacterName + " Hi " + 
                            item.lastCharacterName + ", I would like to buy your '" + 
                            item.name.replace( "<<set:MS>><<set:M>><<set:S>>", "" ) +
                            "' for '" + item.price + " " + item.currency + 
                            "'. This item is in stash '" + item.stashName + "'. Thank you :)";
                        // import copy from 'copy-to-clipboard';
                        ncp.copy( str, function() {
                            console.log( "copied to clipboard" );
                        });
                    })
                }

                function drawChart( items ) {
                    // console.log( items );
                    var ctx = $( "#myChart" );
                    var background = [];
                    var border     = [];
                    for ( var i = 0 ; i < items.values.length ; i++ ) {
                        background.push( 'rgba(75, 192, 192, 0.4)' );
                        border.push( 'rgba(75, 192, 192, 1)' );
                        items.values[i] = Math.round( items.values[i] * 100 ) / 100;
                    }
                    if ( myChart ) {
                        myChart.destroy();
                        delete myChart;
                    }
                    myChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: items.values,
                            datasets: [{
                                label: 'Price distribution in ' + items.currency,
                                data: items.amounts,
                                backgroundColor: background,
                                borderColor: border,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                yAxes: [{
                                    ticks: {
                                        beginAtZero:true
                                    }
                                }]
                            }
                        }
                    });
                }

                // GUI binding
                // Update market prices when clicked
                $( "#update-market" ).click( function() {
                    baseCurrency = $( "#base-currency" ).val();
                    updateMarketRates( function() {});
                });

                // Update league value when changed
                $( "#league" ).change( function() {
                    league = $( this ).val();
                    console.log( league );
                });

                // WHen clicking on search button
                $( "#search-item" ).click( function() {
                    var searchDelay = 10000;
                    var search = function() {
                        var text  = $( "textarea" ).val();
                        var lines = text.split( "\n" );
                        var searchBy = $( "#search-by" ).val();
                        
                        // if ( searchBy === "mods" ) {
                        //     for ( var i = 0 ; i < lines.length ; i++ ) {
                        //         console.log( lines[i] );
                        //         var splitted = lines[i].split( " " );
                        //         for ( var j = 0 ; j < splitted.length ; j++ ) {
                        //             var char     = splitted[j].charAt(0);
                        //             var charCode = splitted[j].charCodeAt(0);
                        //             var newChar;
                        //             var newCharCode;
                        //             if ( charCode > 90 ) {
                        //                 // We need to fetch the upper case char
                        //                 newCharCode = charCode - 32;
                        //             } else {
                        //                 // We fetch the lower case char
                        //                 newCharCode = charCode + 32;
                        //             }
                        //             newChar = String.fromCharCode( newCharCode );
                        //             splitted[j] = "[" + char + newChar + "]" + splitted[j].substr( 1, splitted[j].length - 1 );
                        //         }
                        //         var str = splitted.join( " " );
                        //         console.log( str );
                        //         lines[i] = new RegExp( str );
                        //     }
                        // }
                        $( "#search .loading" ).fadeIn( 'fast' );
                        if ( searchBy === "name" ) {
                            connectToDB( function( db ) {
                                queryDB( db, lines[0], league, searchBy, filterValidPrice );
                            });
                        } else if ( searchBy === "lastCharacterName" ) {
                            connectToDB( function( db ) {
                                queryDB( db, lines[0], league, searchBy, filterValidPrice );
                            });
                        } else if ( searchBy === "accountName" ) {
                            connectToDB( function( db ) {
                                queryDB( db, lines[0], league, searchBy, filterValidPrice );
                            });
                        } else {
                            connectToDB( function( db ) {
                                queryDB( db, lines, league, searchBy, filterValidPrice );
                            });
                        }
                    }
                    search();
                    if ( $( "#auto-refresh" ).is( ':checked' )) {
                        clearInterval( autorefreshInterval );
                        autorefreshInterval = setInterval( search, searchDelay );
                    } else {
                        clearInterval( autorefreshInterval );
                    }
                    
                });

                $( "#item-type" ).change( function() {
                    $( "#item-subtype" ).empty();
                    var types = itemTypes[$( this ).val()].types;
                    types.sort();
                    for ( var i = 0 ; i < types.length ; i++ ) {
                        $( "#item-subtype" ).append(
                            "<option value='" + types[i] + "'>" + types[i] + " </option>"
                        );
                    }
                })

                process.on('SIGINT', cleanup );
                process.on('SIGTERM', cleanup );

                function cleanup() {
                    dbHandler.close();
                }

            });
        </script>
    </body>
</html>
